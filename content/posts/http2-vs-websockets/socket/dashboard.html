<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        .chart {
            width: 350px; height: 200px;
            margin: 3px; border: 1px solid black;
            position: relative; float: left;
        }
    </style>
</head>

<body>
    <div id="app">
        <p>Loaded charts: {{loaded_chart_count}}</p>
        <div v-for="chart in charts" class="chart">
            <chart :widget="chart" v-once></chart>
        </div>
    </div>
  
<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.21/vue.min.js'></script>

<script >
console.time('load'); // Measure time from here to end of load
const DATA_LEN = 50;
const CHARTS_COUNT = 50;

var data = {
    charts: _.range(CHARTS_COUNT),
    loaded_chart_count: 0,
};


Vue.component('chart', {
  template: '<canvas width="350" height="200"></canvas>',
  props: ['widget'],
  mounted: function() {
    createChart(this.$el, this.widget);
  }
});

var createChart = function(el, widget) {
    // Load data and render line chart in given element
    loadData(widget, function(chart_data) {
      new Chart(el, {
          type: 'line',
          data: {
              labels: _.range(chart_data.length),
              datasets: [{
                  label: 'Data ' + widget,
                  data: chart_data,
              }]
          },
      });
      data.loaded_chart_count ++;
      if(data.loaded_chart_count == CHARTS_COUNT) {
        console.timeEnd('load'); // stop load timer
      }
    });
};

var ws = new WebSocket('ws://' + document.domain + ':' + location.port + '/api/ws/');

ws.onopen = function() {
    // Vue instance should be created after socket is open because otherwise 
    // components could try to send requests before it opens, and will fail
    new Vue({
      el: "#app",
      data: data
    });
}

var socketSubscribers = {};
ws.onmessage = function (event) {
    var data = JSON.parse(event.data);
    var subscriber = socketSubscribers[data.id];
    if(subscriber) {
        subscriber(data);
        // TODO: maybe remove subscriber
    };
};

function get_unique_id() {
    // Will not work for multiple users, for production use some UUID implementation
    get_unique_id.uid = (get_unique_id.uid || 0) + 1;
    return get_unique_id.uid
}

function loadData(widget, cb) {
    // Load data for widget given, and when it is loaded - call cb
    var id = get_unique_id();
    ws.send(JSON.stringify({
        id: id, 
        data: widget,
        size: DATA_LEN,
    }));
    socketSubscribers[id] = function (data) {
        cb(data.data);
    };
}
</script>
</body>
</html>
